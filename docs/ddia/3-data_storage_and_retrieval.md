# 数据处理与检索

## OLTP vs OLAP

| 属性   | OLTP         | OLAP           |
| :--- | :----------- | :------------- |
| 读特征  | 基于键，每次返回少量记录 | 对大量记录进行汇总      |
| 写特征  | 随机访问，低延迟写入   | 批量导入（ETL）或事件流  |
| 使用场景 | 终端用户通过应用程序访问 | 内部分析决策使用       |
| 数据表征 | 最新的数据状态      | 随着事件变化而变化的事件历史 |
| 数据规模 | GB-TB        | TB - PB        |

## OLTP - 在线事务处理

* 面向用户，接受大量的请求
* 存储引擎使用索引查找所查询的数据记录
* 每次查询通常只涉及少量记录
* 磁盘寻址时间是瓶颈

## OLAP - 在线分析处理

- 面向业务分析，接受少量请求
- 每次查询需要在短时间内扫描大量记录并仅读取少数几列
- 磁盘带宽是瓶颈
- 大量的行扫描时索引的关联性显著降低，而更紧凑的编码数据可以减少磁盘读取量

## 存储引擎

高效的查询数据库中的特定键的值需要**索引**，索引是基于原始数据派生而来的额外数据结构，各种索引背后的基本思想都是保留一些额外的元数据，把这些元数据做为数据的标记帮助定位；针对不同的搜索方式搜索相同数据可以定义多种不同的索引。索引涉及存储系统中重要的权衡设计，即适当的索引可以加速读取查询，但每次写入时都需要更新索引，因此任何类型的索引都会降低写入速度。

### 内存哈希存储引擎

键值数据存储全部以追加的方式写入文件；将数据的键及数据的值在文件中的偏移位置存储在内存中的哈希表中。写入时：将键值写入日志文件并更新内存中的哈希表；读取时：通过键查询值在文件中的偏移位置，然后读取其内容。

当日志文件到达一定大小，关闭当前日志文件并不再修改，后续数据将被写入到新的日志文件中，然后可以在已关闭的日志文件上执行压缩，即丢弃重复键值并只保留最新键值。压缩使得日志文件更小，还可以在执行压缩过程中将多个日志合并在一起，由关闭的日志文件不会被修改，所以压缩合并后的数据将被写入新的日志文件中，这些操作均在后台线程中完成并且同时旧的日志文件依然提供正常的读写请求。压缩合并后写请求将切换到新的日志文件中，就的日志文件可以安全的删除。

每个日志文件都有自己的哈希表，将键映射到文件的偏移位置。读取时首先查询最新的哈希表，如果不存在则一次检查旧的哈希表，由于压缩合并的存在，通常只会维持少量的日志文件，因此不会查询很多哈希表。

这类存储引擎适合键全部存储在内存中可行并且频繁写入更新的场景，因为只需要一次磁盘寻址（如果日志文件已经在文件系统中的缓存里，则不需要任何磁盘I/O），可以提供高性能的读和写。追加和分段日志文件主要是顺序写，相比于随机写快得多，特别是对于机械硬盘，并且某种程度上即使是SSD也是合适的；日志文件是关闭后是不可变的，在并发和崩溃恢复要简单得多，不会发生崩溃后新旧数据混在得情况；合并压缩旧得日志文件也避免了随着时间推移日志文件得碎片化问题。

局限性：

- 哈希表必须全部放入内存，无法应对大量键的场景（即使考虑将哈希表存储到磁盘上，大量随机I/O和哈希冲突都是代价昂贵的）。
- 哈希表的无序性导致只能逐个查询而不能区间查询。

实现中的一些重要问题：

- 文件格式

  二进制格式是最适合的日志文件格式。

- 删除记录

  删除数据在日志文件中追加一条特殊的数据（这里成为墓碑），当合并压缩时遇到墓碑标记则丢弃已经删除数据的所有值。

- 崩溃恢复

  数据库崩溃重启后，最简单的方式是读取所有日志文件来重建哈希表，但如果日志文件很大时读取时间可能很长，使得重启变得缓慢。通过为每个日志文件建立哈希表快照并存储在磁盘上来加快恢复速度。

- 部分数据写入

  为每个键值提供校验值可以发现损坏的部分并丢弃。

- 并发控制

  由于写入以严格的先后顺序追加到文件，通常只有一个写线程。日志文件是追加的并且不可变的，所以可以被多个线程同时读取。

代表产品：BitCask，Dynamo，Beansdb（gobeansdb）

### 日志结构存储引擎 LSM-Tree

类似于内存哈希表存储引擎，这里有一些不同，日志文件格式（SSTable），要求键值对按键排序，并且每个日志文件中每个键只出现一次。这些不同带来以下有点，首先是合并时即使文件大于内存也可采用类似合并排序算法并发读取多个日志文件比较每个文件的第一个键把最小的键写入新的日志文件中，当遇到重复的键时最新的日志文件中的键通常时最新的值。再者这里的内存索引可以是稀疏的，不需要把所有的键保存在内存中。由于内存索引指向的是范围数据，可以将其压缩保存到一个块中以降低磁盘空间，压缩还减少了磁盘I/O带宽。

### 面向页的存储引擎 B-Tree

将磁盘视为一组固定大小可覆盖写的页。

